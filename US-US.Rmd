---
title: "USA-USA"
author: "Andreas Fleischer"
date: "2025-10-10"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Pakker
```{r}
library(readr)
library(tidyverse)
library(frenchdata)
library(ggplot2)
library(lubridate)
library(broom)
library(purrr)
```

# Data
```{r message=FALSE, warning=FALSE}
data_sets = get_french_data_list() # All the datasets in the package


# US stocks
# Nr 1 er månedlige returns
# Nr 2 er årlige returns
ff_3_factors <- download_french_data("Fama/French 3 Factors") # Download of data
# f_3_factors$subsets$data[[2]] # How to extract dataset
# browse_details_page(ff_3_factors) # Details of the dataset


size_mom_6 <- download_french_data("6 Portfolios Formed on Size and Momentum (2 x 3)")
size_mom_25 <- download_french_data("25 Portfolios Formed on Size and Momentum (5 x 5)")


# EU stocks in US dollars
size_mom_6_euro <- download_french_data("6 European Portfolios Formed on Size and Momentum (2 x 3)")
size_mom_25_euro <- download_french_data("25 European Portfolios Formed on Size and Momentum (5 x 5)")

# Other
setwd("/Users/andreas/Documents/Uni/5. År/Asset Allocation (PUK)")
exchange_rate <- read_csv("GitHub/AssetAllocation/Data AA/eurofxref-hist.csv") # Tror det er valutakurser
# exchange_rate <- read_csv("Data AA/eurofxref-hist.csv") #
# Yield_curve_1_year <- read_csv("Data AA/Yield curve 1 year.csv")
# Yield_curve <- read_csv("Data AA/Yield curve full.csv")

All_years <- readRDS("GitHub/AssetAllocation/All_years_ready.rds")
```

# US-US (MKT)
```{r}
true_factors <- ff_3_factors$subsets$data[[1]] %>% filter(date >= 200409)
avg_vw_returns <- size_mom_6$subsets$data[[1]] %>% filter(date >= 200409)
number_firms <- size_mom_6$subsets$data[[5]] %>% filter(date >= 200409)
avg_market_cap <- size_mom_6$subsets$data[[6]] %>% filter(date >= 200409)

total_returns <- data.frame(date = number_firms$date,
                            avg_vw_returns[,-1]*number_firms[,-1]*avg_market_cap[-1]*1/100)
total_values <- data.frame(date = number_firms$date,
                            number_firms[,-1]*avg_market_cap[-1])
total_market_value <- rowSums(total_values[,-1])
MKT_US <- data.frame(date = number_firms$date,
                     Mkt = rowSums(avg_vw_returns[,-1]*total_values[,-1])/total_market_value)

true_factors$`Mkt-RF`-round(MKT_US$Mkt-true_factors$RF[1:252],2)

summary(lm((MKT_US$Mkt[1:244]-true_factors$RF[1:244])~1))$coefficients*c(1,sqrt(244),1,1)
```
# US-US (SMB)
```{r}
SMB_values <- rowMeans(avg_vw_returns[, 2:4]) - rowMeans(avg_vw_returns[, 5:7])
SMB_US <- data.frame(date = number_firms$date,
                     SMB = SMB_values)

SMB_US$SMB-true_factors$SMB
summary(lm(SMB_US$SMB[1:244]~1))$coefficients*c(1,sqrt(244),1,1)

mean(SMB_US$SMB[1:244]-true_factors$RF[1:244])
```
# US-US (MOM)
```{r}
MOM_values <- rowMeans(avg_vw_returns[,c(4,7)]) - rowMeans(avg_vw_returns[,c(2,5)])
MOM_US <- data.frame(date = number_firms$date,
                     MOM = MOM_values)

summary(lm(MOM_US$MOM[1:244]~1))$coefficients*c(1,sqrt(244),1,1)
```

# EUR-US (MKT)
```{r}
EUR_USD <- exchange_rate %>%
  filter(as.Date(Date) >= as.Date("2004-08-01")) %>%
  select(Date, USD) %>%
  mutate(Date = as.Date(Date)) %>%
  group_by(year = year(Date), month = month(Date)) %>%
  slice_max(Date, n = 1) %>%   # last date in each month
  ungroup() %>%
  arrange(Date)
EUR_USD <- EUR_USD[1:253,]
EUR_USD$return <- lag(EUR_USD$USD)/EUR_USD$USD-1
EUR_USD <- EUR_USD[2:253,]

avg_vw_returns_eu <- (1+avg_vw_returns[,-1]/100)*(1+EUR_USD$return)-1
avg_vw_returns_eu <- avg_vw_returns_eu*100

total_values <- number_firms[,-1] * avg_market_cap[,-1]  
total_market_value <- rowSums(total_values)

total_returns_eu <- data.frame(
  date = number_firms$date,
  avg_vw_returns_eu * total_values / 100)

MKT_EU_US <- data.frame(
  date = number_firms$date,
  Mkt = rowSums(avg_vw_returns_eu * total_values) / total_market_value)

t.test(MKT_EU_US$Mkt)
summary(lm((MKT_EU_US$Mkt[1:244]-All_years$return)~1))$coefficients*c(1,sqrt(244),1,1)
```
# EUR-US (SMB)
```{r}
SMB_values_eu <- rowMeans(avg_vw_returns_eu[, 1:3]) - rowMeans(avg_vw_returns_eu[, 4:6])
SMB_EU_US <- data.frame(date = number_firms$date,
                     SMB = SMB_values_eu)
t.test(SMB_EU_US$SMB[1:244])
summary(lm(SMB_EU_US$SMB[1:244]~1))$coefficients*c(1,sqrt(244),1,1)
```
# EUR-US (MOM)
```{r}
MOM_values_eu <- rowMeans(avg_vw_returns_eu[,c(3,6)]) - rowMeans(avg_vw_returns_eu[,c(1,4)])
MOM_EU_US <- data.frame(date = number_firms$date,
                     MOM = MOM_values_eu)

t.test(MOM_EU_US$MOM)
summary(lm(MOM_EU_US$MOM[1:244]~1))$coefficients*c(1,sqrt(244),1,1)
```
# EUR-EU
```{r}
avg_vw_returns_euro <- size_mom_6_euro$subsets$data[[1]] %>% filter(date >= 200409)
number_firms_euro <- size_mom_6_euro$subsets$data[[5]] %>% filter(date >= 200409)
avg_market_cap_euro <- size_mom_6_euro$subsets$data[[6]] %>% filter(date >= 200409)

total_values_euro <- number_firms_euro[,-1] * avg_market_cap_euro[,-1]
total_market_value_euro <- rowSums(total_values_euro)

avg_vw_returns_euro_eur <- ((1 + avg_vw_returns_euro[,-1]/100) * (1 + EUR_USD$return) - 1) * 100

MKT_EU_EU <- data.frame(
  date = number_firms_euro$date,  
  Mkt  = rowSums(avg_vw_returns_euro_eur * total_values_euro) /
         total_market_value_euro)
t.test(MKT_EU_EU$Mkt)
summary(lm((MKT_EU_EU$Mkt[1:244]-All_years$return)~1))$coefficients*c(1,sqrt(244),1,1)
```
# EUR-EU (SMB)
```{r}
SMB_values_eur_eur <- rowMeans(avg_vw_returns_euro_eur[, 1:3]) - 
                      rowMeans(avg_vw_returns_euro_eur[, 4:6])

SMB_EU_EU <- data.frame(
  date = number_firms_euro$date,  
  SMB  = SMB_values_eur_eur
)
t.test(SMB_EU_EU$SMB)
summary(lm(SMB_EU_EU$SMB[1:244]~1))$coefficients*c(1,sqrt(244),1,1)
```
# EUR-EU (MOM)
```{r}
MOM_values_eur_eur <- rowMeans(avg_vw_returns_euro_eur[, c(3,6)]) -
                      rowMeans(avg_vw_returns_euro_eur[, c(1,4)])

MOM_EU_EU <- data.frame(
  date = number_firms_euro$date,  
  MOM  = MOM_values_eur_eur
)

t.test(MOM_EU_EU$MOM)
summary(lm(MOM_EU_EU$MOM[1:244]~1))$coefficients*c(1,sqrt(244),1,1)
```
# Time-series regression (US-US)
```{r}
All_years <- readRDS("All_years_ready.rds")

# Make new FF factor df
RF <- ff_3_factors$subsets$data[[1]] %>% filter(date >= 200409) %>% select(c("RF"))

reg_data <- data.frame(
  date = MKT_US$date,
  MKTmRF = MKT_US$Mkt,
  SMB = SMB_US$SMB,
  MOM = MOM_US$MOM) %>%
  filter(date <= 202412) %>%
  mutate(MKTmRF = MKTmRF - RF$RF[1:244],
         RF = RF$RF[1:244])

avg_vw_returns <- size_mom_25$subsets$data[[1]] %>% filter(date >= 200409)

# Add the portfolios
reg_data <- cbind(
  reg_data,
  avg_vw_returns[1:244,])

# Excess portfolios, R-RF
excess_portfolios <- avg_vw_returns[1:244,-1] - reg_data$RF

# The regressions
ff25_results <- map_dfr(
  names(excess_portfolios),
  ~ {
    model <- lm(excess_portfolios[[.x]] ~ reg_data$MKTmRF + reg_data$SMB + reg_data$MOM)
    
    # Coefficients and t-stats
    coef_df <- tidy(model) %>%
      mutate(
        Portfolio = .x,
        t_stat = estimate / std.error
      ) %>%
      select(Portfolio, term, estimate, t_stat)
    
    # R² and adjusted R² — now as *extra columns*
    model_stats <- glance(model) %>%
      select(r.squared, adj.r.squared)
    
    # Add R² columns to each coefficient row
    coef_df <- coef_df %>%
      mutate(
        r.squared = model_stats$r.squared,
        adj.r.squared = model_stats$adj.r.squared
      )
    
    coef_df
  }
)

# Arrange nicely
ff25_results <- ff25_results %>%
  mutate(term = recode(term,
                       "(Intercept)" = "Alpha",
                       "reg_data$MKTmRF" = "MKT",
                       "reg_data$SMB" = "SMB",
                       "reg_data$MOM" = "MOM")) %>%
  arrange(Portfolio, match(term, c("Alpha", "MKT", "SMB", "MOM")))

# Pivot wider for a clean report table
ff25_table <- ff25_results %>%
  tidyr::pivot_wider(
    names_from = term,
    values_from = c(estimate, t_stat),
    names_glue = "{term}_{.value}"
  ) %>%
  select(Portfolio, starts_with("Alpha"), starts_with("MKT"),
         starts_with("SMB"), starts_with("MOM"),
         r.squared, adj.r.squared)

# View results
ff25_table
round(ff25_table$r.squared,2)
```

# Time-series regression on 5x5 (EU-US)
```{r}
# Make new FF factor df
reg_data_us <- data.frame(
  date = MKT_EU_US$date,
  MKTmRF = MKT_EU_US$Mkt,
  SMB = SMB_EU_US$SMB,
  MOM = MOM_EU_US$MOM) %>%
  filter(date <= 202412) %>%
  mutate(MKTmRF = MKTmRF - All_years$return,
         RF = All_years$return)
# Add the 5x5 data
avg_vw_returns_eu25 <- size_mom_25$subsets$data[[1]] %>% filter(date >= 200409)
avg_vw_returns_eu25 <- (1+avg_vw_returns_eu25[,-1]/100)*(1+EUR_USD$return)-1
avg_vw_returns_eu25 <- avg_vw_returns_eu25*100

# Add the portfolios
reg_data_us <- cbind(
  reg_data_us,
  avg_vw_returns_eu25[1:244,])

# Excess portfolios, R-RF
excess_portfolios_us <- avg_vw_returns_eu25[1:244,] - reg_data_us$RF

# The regressions
ff25_results_us <- map_dfr(
  names(excess_portfolios_us),
  ~ {
    model <- lm(excess_portfolios_us[[.x]] ~ reg_data_us$MKTmRF + reg_data_us$SMB + reg_data_us$MOM)
    
    # Coefficients and t-stats
    coef_df <- tidy(model) %>%
      mutate(
        Portfolio = .x,
        t_stat = estimate / std.error
      ) %>%
      select(Portfolio, term, estimate, t_stat)
    
    # R² and adjusted R² — from glance()
    model_stats <- glance(model) %>%
      select(r.squared, adj.r.squared)
    
    # Add R² columns to every coefficient row (for completeness)
    coef_df <- coef_df %>%
      mutate(
        r.squared = model_stats$r.squared,
        adj.r.squared = model_stats$adj.r.squared
      )
    
    coef_df
  }
)

# Clean up and reorder columns
ff25_results_us <- ff25_results_us %>%
  mutate(term = recode(term,
                       "(Intercept)" = "Alpha",
                       "reg_data_us$MKTmRF" = "MKT",
                       "reg_data_us$SMB" = "SMB",
                       "reg_data_us$MOM" = "MOM")) %>%
  arrange(Portfolio, match(term, c("Alpha", "MKT", "SMB", "MOM")))

# Pivot wider to make a clean report-style table
ff25_table_us <- ff25_results_us %>%
  tidyr::pivot_wider(
    names_from = term,
    values_from = c(estimate, t_stat),
    names_glue = "{term}_{.value}"
  ) %>%
  select(
    Portfolio,
    starts_with("Alpha_"),
    starts_with("MKT_"),
    starts_with("SMB_"),
    starts_with("MOM_"),
    r.squared,
    adj.r.squared
  )

# View results
ff25_table_us
round(ff25_table_us$r.squared,2)
```


# Time-series regression (EU-EU)
```{r}
# Make new FF factor df
reg_data_eu <- data.frame(
  date = MKT_EU_EU$date,
  MKTmRF = MKT_EU_EU$Mkt,
  SMB = SMB_EU_EU$SMB,
  MOM = MOM_EU_EU$MOM) %>%
  filter(date <= 202412) %>%
  mutate(MKTmRF = MKTmRF - All_years$return,
         RF = All_years$return)

# Add the 5x5 data
avg_vw_returns_eu25 <- size_mom_25_euro$subsets$data[[1]] %>% filter(date >= 200409)
avg_vw_returns_eu25 <- (1+avg_vw_returns_eu25[,-1]/100)*(1+EUR_USD$return)-1
avg_vw_returns_eu25 <- avg_vw_returns_eu25*100

# Add the portfolios
reg_data_eu <- cbind(
  reg_data_eu,
  avg_vw_returns_eu25[1:244,])

# Excess portfolios, R-RF
excess_portfolios_eu <- avg_vw_returns_eu25[1:244,] - reg_data_eu$RF

# The regressions
ff25_results_eu <- map_dfr(
  names(excess_portfolios_eu),
  ~ {
    model <- lm(excess_portfolios_eu[[.x]] ~ reg_data_eu$MKTmRF + reg_data_eu$SMB + reg_data_eu$MOM)
    
    # Coefficients and t-stats
    coef_df <- tidy(model) %>%
      mutate(
        Portfolio = .x,
        t_stat = estimate / std.error
      ) %>%
      select(Portfolio, term, estimate, t_stat)
    
    # R² and adjusted R² — from glance()
    model_stats <- glance(model) %>%
      select(r.squared, adj.r.squared)
    
    # Add R² columns to every coefficient row (for completeness)
    coef_df <- coef_df %>%
      mutate(
        r.squared = model_stats$r.squared,
        adj.r.squared = model_stats$adj.r.squared
      )
    
    coef_df
  }
)

# Clean up and reorder columns
ff25_results_eu <- ff25_results_eu %>%
  mutate(term = recode(term,
                       "(Intercept)" = "Alpha",
                       "reg_data_eu$MKTmRF" = "MKT",
                       "reg_data_eu$SMB" = "SMB",
                       "reg_data_eu$MOM" = "MOM")) %>%
  arrange(Portfolio, match(term, c("Alpha", "MKT", "SMB", "MOM")))

# Pivot wider to make a clean report-style table
ff25_table_eu <- ff25_results_eu %>%
  tidyr::pivot_wider(
    names_from = term,
    values_from = c(estimate, t_stat),
    names_glue = "{term}_{.value}"
  ) %>%
  select(
    Portfolio,
    starts_with("Alpha_"),
    starts_with("MKT_"),
    starts_with("SMB_"),
    starts_with("MOM_"),
    r.squared,
    adj.r.squared
  )

# View results
ff25_table_eu
round(ff25_table_eu$r.squared,2)
```
# GRS intercept test
```{r}
GRS_test <- function(excess_portfolios, reg_data) {
  # Ensure matrix types
  R  <- as.matrix(excess_portfolios)        # T x N
  Ft <- as.matrix(reg_data)                 # T x K
  
  Tobs <- nrow(R)
  N    <- ncol(R)
  K    <- ncol(Ft)
  
  # Add intercept
  X <- cbind(Intercept = 1, Ft)             # T x (K+1)
  
  # OLS for all portfolios in one go
  # B = (X'X)^(-1) X'R   -> (K+1) x N, first row are alphas
  XtX <- t(X) %*% X
  XtX_inv <- solve(XtX + diag(1e-1, ncol(XtX)))  # add small ridge term
  Bhat    <- XtX_inv %*% t(X) %*% R
  alpha_hat <- as.vector(Bhat[1, ])         # N x 1
  # Residuals: E = R - X Bhat
  E <- R - X %*% Bhat                       # T x N
  # Residual covariance (unbiased with T-K-1 in denominator)
  Sigma_e <- (t(E) %*% E) / (Tobs - K - 1)  # N x N
  
  # Factor means and covariance
  fbar <- colMeans(Ft)                      # K x 1
  Sigma_f <- cov(Ft)                        # K x K (div by T-1)
  
  # GRS components
  A <- t(alpha_hat) %*% solve(Sigma_e) %*% alpha_hat
  Bterm <- 1 + t(fbar) %*% solve(Sigma_f) %*% fbar
  GRS <- as.numeric(((Tobs - N - K) / N) * (A / Bterm))
  
  # Degrees of freedom & p-value
  df1 <- N
  df2 <- Tobs - N - K
  pval <- 1 - pf(GRS, df1, df2)
  
  list(
    GRS = GRS,
    df1 = df1,
    df2 = df2,
    p_value = pval,
    alpha = alpha_hat,
    Sigma_e = Sigma_e
  )
}

```



# Summarize expected surplus and covariance
```{r}
recommended_factors <- data.frame(MKT_US = MKT_EU_US$Mkt[1:244]-All_years$return, 
                                  MOM_US = MOM_EU_US$MOM[1:244],
                                  MKT_EU = MKT_EU_EU$Mkt[1:244]-All_years$return,
                                  SMB_EU = SMB_EU_EU$SMB[1:244],
                                  MOM_EU = MOM_EU_EU$MOM[1:244])

round(colMeans(recommended_factors),3)
round(cov(recommended_factors),2)

all_factors <- data.frame(MKT_US = MKT_EU_US$Mkt[1:244]-All_years$return,
                          SMB_US = SMB_EU_US$SMB[1:244],
                          MOM_US = MOM_EU_US$MOM[1:244],
                          MKT_EU = MKT_EU_EU$Mkt[1:244]-All_years$return,
                          SMB_EU = SMB_EU_EU$SMB[1:244],
                          MOM_EU = MOM_EU_EU$MOM[1:244])
round(cor(all_factors),2)
```


# Long-Only (SMB EU-US)
```{r}
SMB_values_eu_us_long <- rowMeans(avg_vw_returns_eu[, 1:3])
SMB_EU_US_long <- data.frame(date = number_firms$date,
                     SMB = SMB_values_eu_us_long)
t.test(SMB_EU_US_long$SMB[1:244])
summary(lm((SMB_EU_US_long$SMB[1:244]-All_years$return)~1))$coefficients*c(1,sqrt(244),1,1)
```
# Long-Only (MOM EU-US)
```{r}
MOM_values_eu_us_long <- avg_vw_returns_eu[,6]
MOM_EU_US_long <- data.frame(date = number_firms$date,
                     MOM = MOM_values_eu_us_long)
t.test(MOM_EU_US_long$MOM[1:244])
summary(lm((MOM_EU_US_long$MOM[1:244]-All_years$return)~1))$coefficients*c(1,sqrt(244),1,1)
```
# Long-Only (SMB EU-EU)
```{r}
SMB_values_eu_eu_long <- rowMeans(avg_vw_returns_euro_eur[, 1:3])
SMB_EU_EU_long <- data.frame(date = number_firms$date,
                     SMB = SMB_values_eu_eu_long)
t.test(SMB_EU_EU_long$SMB[1:244])
summary(lm((SMB_EU_EU_long$SMB[1:244]-All_years$return)~1))$coefficients*c(1,sqrt(244),1,1)
```
# Long-Only (MOM EU-EU)
```{r}
MOM_values_eu_eu_long <- avg_vw_returns_euro_eur[,6]
MOM_EU_EU_long <- data.frame(date = number_firms$date,
                     MOM = MOM_values_eu_eu_long)
t.test(MOM_EU_EU_long$MOM[1:244])
summary(lm((MOM_EU_EU_long$MOM[1:244]-All_years$return)~1))$coefficients*c(1,sqrt(244),1,1)
```

```{r}
readRDS("new_factors.rds")
```

# Time-Series (EU-US) Long-Only
```{r}
reg_data_us <- data.frame(
  date = MKT_EU_US$date,
  MKTmRF = MKT_EU_US$Mkt,
  SMB = SMB_EU_US_long$SMB,
  MOM = MOM_EU_US_long$MOM) %>%
  filter(date <= 202412) %>%
  mutate(MKTmRF = MKTmRF - All_years$return,
         RF = All_years$return,
         SMB = SMB-RF,
         MOM = MOM-RF)

# The regressions
ff25_results_us <- map_dfr(
  names(excess_portfolios_us),
  ~ {
    model <- lm(excess_portfolios_us[[.x]] ~ reg_data_us$MKTmRF + reg_data_us$SMB + reg_data_us$MOM)
    
    # Coefficients and t-stats
    coef_df <- tidy(model) %>%
      mutate(
        Portfolio = .x,
        t_stat = estimate / std.error
      ) %>%
      select(Portfolio, term, estimate, t_stat)
    
    # R² and adjusted R² — from glance()
    model_stats <- glance(model) %>%
      select(r.squared, adj.r.squared)
    
    # Add R² columns to every coefficient row (for completeness)
    coef_df <- coef_df %>%
      mutate(
        r.squared = model_stats$r.squared,
        adj.r.squared = model_stats$adj.r.squared
      )
    
    coef_df
  }
)

# Clean up and reorder columns
ff25_results_us <- ff25_results_us %>%
  mutate(term = recode(term,
                       "(Intercept)" = "Alpha",
                       "reg_data_us$MKTmRF" = "MKT",
                       "reg_data_us$SMB" = "SMB",
                       "reg_data_us$MOM" = "MOM")) %>%
  arrange(Portfolio, match(term, c("Alpha", "MKT", "SMB", "MOM")))

# Pivot wider to make a clean report-style table
ff25_table_us <- ff25_results_us %>%
  tidyr::pivot_wider(
    names_from = term,
    values_from = c(estimate, t_stat),
    names_glue = "{term}_{.value}"
  ) %>%
  select(
    Portfolio,
    starts_with("Alpha_"),
    starts_with("MKT_"),
    starts_with("SMB_"),
    starts_with("MOM_"),
    r.squared,
    adj.r.squared
  )

# View results
ff25_table_us
```


# Time-Series (EU-EU) Long-Only
```{r}
reg_data_eu <- data.frame(
  date = MKT_EU_EU$date,
  MKTmRF = MKT_EU_EU$Mkt,
  SMB = SMB_EU_EU_long$SMB,
  MOM = MOM_EU_EU_long$MOM) %>%
  filter(date <= 202412) %>%
  mutate(MKTmRF = MKTmRF - All_years$return,
         RF = All_years$return)

# The regressions
ff25_results <- map_dfr(
  names(excess_portfolios_eu),
  ~ {
    model <- lm(excess_portfolios_eu[[.x]] ~ reg_data_eu$MKTmRF + reg_data_eu$SMB + reg_data_eu$MOM)
    tidy(model) %>%
      mutate(
        Portfolio = .x,
        t_stat = estimate / std.error
      ) %>%
      select(Portfolio, term, estimate, t_stat)
  }
)

# Arrange nicely
ff25_results <- ff25_results %>%
  mutate(term = recode(term,
                       "(Intercept)" = "Alpha",
                       "reg_data_eu$MKTmRF" = "MKT",
                       "reg_data_eu$SMB" = "SMB",
                       "reg_data_eu$MOM" = "MOM")) %>%
  arrange(Portfolio, match(term, c("Alpha", "MKT", "SMB", "MOM")))

# (Optional) Pivot wider for a report-style table
ff25_table <- ff25_results %>%
  tidyr::pivot_wider(
    names_from = term,
    values_from = c(estimate, t_stat),
    names_glue = "{term}_{.value}"
  )

# View results
ff25_table
round(ff25_table$MOM_t_stat,2)
```
# Long-Only summary
```{r}
recommended_factors_long <- data.frame(SMB_US = SMB_EU_EU_long$SMB[1:244]-All_years$return,
                                       MOM_US = MOM_EU_US_long$MOM[1:244]-All_years$return,
                                  SMB_EU = SMB_EU_EU_long$SMB[1:244]-All_years$return,
                                  MOM_EU = MOM_EU_EU_long$MOM[1:244]-All_years$return)

round(colMeans(recommended_factors_long),3)
round(cov(recommended_factors_long),3)

all_factors_long <- data.frame(MKT_US = MKT_EU_US$Mkt[1:244]-All_years$return,
                               SMB_US = SMB_EU_US_long$SMB[1:244],
                               MOM_US = MOM_EU_US_long$MOM[1:244],
                               MKT_EU = MKT_EU_EU$Mkt[1:244]-All_years$return,
                               SMB_EU = SMB_EU_EU_long$SMB[1:244],
                               MOM_EU = MOM_EU_EU_long$MOM[1:244])
round(cor(all_factors_long),2)
round(cov(all_factors_long),2)
```



```{r}
library(quadprog)
factor.df <- data.frame(SMB_us = SMB_EU_US$SMB,
                        MOM_us = MOM_EU_US$MOM,
                        SMB_eu = SMB_EU_EU$SMB,
                        MOM_eu = MOM_EU_EU$MOM)
cov.mat <- cov(factor.df)
mean.vec <- colMeans(factor.df-All_years$return)

optimize_portfolio <- function(excess_returns, cov_period){
  n_assets <- length(excess_returns)
  
  Dmat <- cov_period
  dvec <- rep(0, n_assets)
  Amat <- cbind(rep(1, n_assets))
  bvec <- c(
    1                   # The value for the first constraint (sum(...) = 1)
  )
  meq <- 0
  
  sol<- solve.QP(Dmat = Dmat,
                              dvec = dvec,
                              Amat = Amat,
                              bvec = bvec,
                              meq = meq)
  w <- sol$solution/sum(sol$solution)
  return(w)
}

opt.w <- optimize_portfolio(mean.vec,cov.mat)

t(opt.w)%*%mean.vec
t(opt.w)%*% cov.mat %*%opt.w
```


# CPPI
```{r}
# Calculation of guarantees
TTM <-  seq(10, 0, -1/12)
L_target <- 125/100
L_trigger <- 130/100

Guarantees <- c()
for (j in 36:124){
  ZCB_prices <-  All_years %>% 
    filter(TIME_PERIOD >= All_years$TIME_PERIOD[j] &
             TIME_PERIOD <= All_years$TIME_PERIOD[j+120]) %>% 
    mutate(
    TTM = TTM,
    z = BETA0 +
      BETA1 * ((1 - exp(-TTM / TAU1)) / (TTM / TAU1)) +
      BETA2 * ((1 - exp(-TTM / TAU1)) / (TTM / TAU1) - exp(-TTM / TAU1)) +
      BETA3 * ((1 - exp(-TTM / TAU2)) / (TTM / TAU2) - exp(-TTM / TAU2)),
    P_T = exp(-z/100 * TTM))
  ZCB_prices$P_T[121] <- 1
  E_returns <- (MKT_EU_EU %>% filter(ym(date) >= All_years$TIME_PERIOD[j]))$Mkt/100
  
  N <- 80/ZCB_prices$P_T[1]
  eta0 <- 20
  A <- 1
  A <- eta0*A
  
  for (i in 1:120){
    A <- (1+E_returns[i])*A
    R <- N*ZCB_prices$P_T[i+1]
    if ((A+R)/R > L_trigger){
      N <- (A+R)/(L_target*ZCB_prices$P_T[i+1])
    }
  }
  Guarantees[j-35] <- N
}
Guarantees

guarantee_df <- data.frame(date = All_years$TIME_PERIOD[36:124],
                           Guarantee = Guarantees)
ggplot(guarantee_df, aes(x = as.Date(date), y = Guarantee)) +
  geom_line(color = "#0072B2", size = 1.1) +
  geom_point(color = "#0072B2", size = 2, alpha = 0.7) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years") +
  scale_y_continuous(labels = scales::number_format(accuracy = 0.01)) +
  labs(
    title = "Development of the Portfolio Guarantee Over Time",
    subtitle = "Guarantee level implied by CPPI floor mechanism (in EUR terms)",
    x = "Date",
    y = "Guarantee Value"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 15, hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray40"),
    axis.title = element_text(face = "bold"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )
```

# CPPI Extended
```{r}
L_target <- 125/100
L_trigger <- 130/100
m <- 1

CPPI <- function(m,L_target,L_trigger,return_series){
  Guarantees <- c()
for (j in 36:124){
  ZCB_prices <-  All_years %>% 
    filter(TIME_PERIOD >= All_years$TIME_PERIOD[j] &
             TIME_PERIOD <= All_years$TIME_PERIOD[j+120]) %>% 
    mutate(
    TTM = TTM,
    z = BETA0 +
      BETA1 * ((1 - exp(-TTM / TAU1)) / (TTM / TAU1)) +
      BETA2 * ((1 - exp(-TTM / TAU1)) / (TTM / TAU1) - exp(-TTM / TAU1)) +
      BETA3 * ((1 - exp(-TTM / TAU2)) / (TTM / TAU2) - exp(-TTM / TAU2)),
    P_T = exp(-z/100 * TTM))
  ZCB_prices$P_T[121] <- 1
  E_returns <- (return_series %>% filter(ym(date) >= All_years$TIME_PERIOD[j]))$Mkt/100
  
  W <- 100
  Floor <- 80
  C <- W-Floor
  E <- max(min(m*C,W),0)
  A <- E
  etaR <- (W-E)/ZCB_prices$P_T[1]
  N <- Floor/ZCB_prices$P_T[1]
  for (i in 1:120){
    A <- (1+E_returns[i])*A
    R <- etaR*ZCB_prices$P_T[i+1]
    W <- A+R
    Floor <- N*ZCB_prices$P_T[i+1]
    C <- W-Floor
    E <- max(min(m*C,W),0)
    A <- E
    etaR <- (W-E)/ZCB_prices$P_T[i+1]
    
    
    if (W/Floor > L_trigger){
      N <- W/(L_target*ZCB_prices$P_T[i+1])
    }
  }
  Guarantees[j-35] <- Floor
}
  return(Guarantees)
}
var(CPPI(14,125/100,130/100, MKT_EU_EU))
```

# Efficient frontier plot
```{r}
library(ggplot2)

# === Example inputs ===
mu <- c(0.08, 0.12)  # expected returns
Sigma <- matrix(c(0.04^2, 0.04*0.06*0.5,
                  0.04*0.06*0.5, 0.06^2), nrow = 2)

# === Analytical Global Minimum Variance Portfolio (GMVP) ===
one <- rep(1, 2)
w_gmv <- solve(Sigma) %*% one / as.numeric(t(one) %*% solve(Sigma) %*% one)
w_gmv <- as.vector(w_gmv)
w_gmv <- pmax(pmin(w_gmv, 1), 0)  # enforce 0 <= w <= 1
w_gmv <- w_gmv / sum(w_gmv)

# === Compute efficient frontier (no short-selling) ===
w1 <- seq(w_gmv[1], 0, length.out = 100)
w2 <- 1 - w1

port_return <- w1 * mu[1] + w2 * mu[2]
port_sd <- sqrt(w1^2 * Sigma[1,1] + w2^2 * Sigma[2,2] + 2 * w1 * w2 * Sigma[1,2])
ef <- data.frame(SD = port_sd, Return = port_return)
ef <- ef[order(ef$SD), ]

# === Mark GMV and Max Return ===
gmv_point <- data.frame(SD = sqrt(t(w_gmv) %*% Sigma %*% w_gmv),
                        Return = sum(w_gmv * mu),
                        Label = "GMV")

max_point <- data.frame(SD = sqrt(Sigma[2,2]),
                        Return = mu[2],
                        Label = "Max Return")

# === Plot ===
ggplot(ef, aes(x = SD, y = Return)) +
  geom_path(color = "#1f77b4", size = 1.4, lineend = "round") +
  geom_point(data = gmv_point, aes(x = SD, y = Return), color = "darkred", size = 3.5) +
  geom_point(data = max_point, aes(x = SD, y = Return), color = "darkgreen", size = 3.5) +
  geom_text(data = gmv_point, aes(label = Label), nudge_x = -0.001, nudge_y = 0.001, size = 3) +
  geom_text(data = max_point, aes(label = Label), nudge_x = -0.002, nudge_y = 0.002, size = 3) +
  labs(
    x = expression(sigma),
    y = expression(mu)
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text = element_blank(),          # remove tick labels
    axis.ticks = element_blank(),         # remove ticks
    panel.grid = element_blank(),         # remove background grid
    axis.line = element_line(color = "black", linewidth = 0.6),  # add clean axes
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.title.y = element_text(angle = 0, vjust = 0.5)  # rotate μ clockwise
  )

```

# Efficient Frontier plot extended
```{r}
library(ggplot2)

# Example data
mu <- c(0.08, 0.12)
Sigma <- matrix(c(0.04^2, 0.04*0.06*0.5,
                  0.04*0.06*0.5, 0.06^2), nrow = 2)

# Grid of weights
w1 <- seq(0, 1, length.out = 200)
w2 <- 1 - w1
port_return <- w1 * mu[1] + w2 * mu[2]
port_sd <- sqrt(w1^2 * Sigma[1,1] + w2^2 * Sigma[2,2] + 2 * w1 * w2 * Sigma[1,2])
ef <- data.frame(SD = port_sd, Return = port_return)
ef <- ef[order(ef$SD), ]

# Identify Global Minimum Variance (GMV) portfolio
one <- rep(1, 2)
w_gmv <- solve(Sigma) %*% one / as.numeric(t(one) %*% solve(Sigma) %*% one)
w_gmv <- as.vector(w_gmv)
gmv_return <- sum(w_gmv * mu)
gmv_sd <- sqrt(t(w_gmv) %*% Sigma %*% w_gmv)

# Keep only efficient (upper) part of the frontier
ef_efficient <- ef[ef$Return >= gmv_return, ]

# GMV and Max Return points
gmv_point <- data.frame(SD = gmv_sd, Return = gmv_return, Label = "GMV")
max_point <- ef_efficient[which.max(ef_efficient$Return), ]
max_point$Label <- "Max Return"

# 5 equidistant points (in expected return)
intermediate_returns <- seq(gmv_return, max_point$Return, length.out = 7)[2:6]
inter_points <- data.frame(Return = intermediate_returns)
inter_points$SD <- approx(ef_efficient$Return, ef_efficient$SD, xout = inter_points$Return)$y
inter_points$Label <- paste("Portfolio", 1:5)

# Combine all points
points_df <- rbind(gmv_point, inter_points, max_point)

# Plot
ggplot(ef_efficient, aes(x = SD, y = Return)) +
  geom_path(color = "#1f77b4", size = 1.4, lineend = "round") +
  geom_point(data = points_df, aes(x = SD, y = Return), color = "darkred", size = 3.5) +
  geom_text(data = points_df, aes(label = Label),
            nudge_y = 0.001, nudge_x = -0.002, size = 3, vjust = -0.5) +
  labs(x = expression(sigma), y = expression(mu)) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.6),
    axis.title.y = element_text(angle = 0, vjust = 0.5)
  )

```
