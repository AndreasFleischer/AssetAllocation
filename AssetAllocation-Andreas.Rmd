---
title: "AssetAllocation"
author: "Nikolaj Andreasen (Andreas har kopieret)"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Pakker
```{r}
library(readr)
library(tidyverse)
library(frenchdata)
library(ggplot2)
library(lubridate)
```

# Loading data
```{r}
data_sets = get_french_data_list() # All the datasets in the package


# US stocks
# Nr 1 er månedlige returns
# Nr 2 er årlige returns
ff_3_factors <- download_french_data("Fama/French 3 Factors") # Download of data
# f_3_factors$subsets$data[[2]] # How to extract dataset
# browse_details_page(ff_3_factors) # Details of the dataset


size_mom_6 <- download_french_data("6 Portfolios Formed on Size and Momentum (2 x 3)")
size_mom_25 <- download_french_data("25 Portfolios Formed on Size and Momentum (5 x 5)")
browse_details_page(size_mom_25_euro)

# EU stocks in US dollars
size_mom_6_euro <- download_french_data("6 European Portfolios Formed on Size and Momentum (2 x 3)")
size_mom_25_euro <- download_french_data("25 European Portfolios Formed on Size and Momentum (5 x 5)")

# Other
exchange_rate <- read_csv("Data AA/eurofxref-hist.csv") # Tror det er valutakurser
# Yield_curve_1_year <- read_csv("Data AA/Yield curve 1 year.csv")
# Yield_curve <- read_csv("Data AA/Yield curve full.csv")
```


# Visualisering
## farma and french 3 factor
```{r}
# 1 er månedlig
# 2 er årlig
# Hvis månedlig skal mutate(date = ym(date)) være med
ff_3_factors$subsets$data[[1]] %>%
  mutate(date = ym(date)) %>% 
  pivot_longer(cols = -date,
               names_to = "factor",
               values_to = "value") %>%
  ggplot(data = .,
         mapping = aes(x = date, y = value,
                       group = factor,
                       color = factor)) +
  geom_line() +
  facet_wrap(~factor, scales = "free")

# histogram
ff_3_factors$subsets$data[[1]] %>%
  mutate(date = ym(date)) %>% 
  pivot_longer(cols = -date,
               names_to = "factor",
               values_to = "value") %>%
  ggplot(data = .,
         mapping = aes(y = value,
                       group = factor,
                       fill = factor)) +
  geom_histogram(color = "white") +
  facet_wrap(~factor, scales = "free") +
  coord_flip()
```

## size og momentum for 6 portføljer USA
```{r}
size_mom_6$subsets$data[[1]] %>% 
  mutate(date = ym(date)) %>% 
  pivot_longer(cols = -date,
               names_to = "type",
               values_to = "value") %>% 
  ggplot(data = .,
         aes(x = date, y = value,
             group = type,
             color = type)) +
  geom_line() +
  facet_wrap(~type, scales = "free")

# histogram
size_mom_6$subsets$data[[1]] %>% 
  pivot_longer(cols = -date,
               names_to = "type",
               values_to = "value") %>% 
  ggplot(data = .,
         aes(y = value,
             group = type,
             fill = type)) +
  geom_histogram(color = "white") +
  facet_wrap(~type, scales = "free") +
  coord_flip()
```

# 1 Factor design
## a)
### i)
```{r}
size_mom_6$subsets$name # De forskellige datasets


# Plot af de forskellige dataset i size_mom_6
k <- 6
filter(size_mom_6$subsets$data[[k]], date >= 200409) %>% 
  mutate(date = ym(date)) %>% 
  pivot_longer(cols = -date,
               names_to = "group",
               values_to = "value") %>% 
  ggplot(aes(date, value, color = group)) +
  geom_line() +
  facet_wrap(~group, scales = "free") +
  theme(legend.position = "bottom") +
  ggtitle(size_mom_6$subsets$name[k])


# Total return
# Ved ikke lige hvordan dette skulle regnes, men ud fra hint og at det er givet som et vægtet gennemsnit kunne det være dette
# r er Average Value Weighted Returns -- Monthly
# n er Number of Firms in Portfolios
# a er Average Firm Size (market cap)
r <- filter(size_mom_6$subsets$data[[1]], date >= 200409)[,2:ncol(size_mom_6$subsets$data[[1]])]
n <- filter(size_mom_6$subsets$data[[5]], date >= 200409)[,2:ncol(size_mom_6$subsets$data[[5]])]
a <- filter(size_mom_6$subsets$data[[6]], date >= 200409)[,2:ncol(size_mom_6$subsets$data[[6]])]

total_returns_6 <- tibble(date = size_mom_6$subsets$data[[1]]$date[size_mom_6$subsets$data[[1]]$date >= 200409], 
                          r*n*a)
total_returns_6 %>% 
  mutate(date = ym(date)) %>% 
  pivot_longer(cols = -date,
               names_to = "group",
               values_to = "value") %>% 
  ggplot(aes(date, value, color = group)) +
  geom_line() +
  facet_wrap(~group, scales = "free") +
  theme(legend.position = "bottom")

# samlet return over hele perioden givet i mio. USD
colSums(total_returns_6[,-1])/10^6


# gennemsnitlige firm size i perioden
colMeans(filter(size_mom_6$subsets$data[[6]], date >= 200409)[, 2:length(filter(size_mom_6$subsets$data[[6]], date >= 200409))])

13.65303      67.35745      96.60903     274.06578     812.65279     543.42334 

```

### ii)
```{r}
# Afkast af at holde USD som EUR-based investor på månedlig basis
df <- exchange_rate[,1:2]
df <- filter(df, Date > as.Date("2004-09-01"))

monthly <- df %>%
  group_by(year = year(Date), month = month(Date)) %>%
  slice_tail(n = 1) %>%
  ungroup() %>%
  mutate(period = as.Date(paste(year, month, "01", sep = "-")))

# Compute monthly returns (EUR-based investor holding USD)
monthly <- monthly %>%
  mutate(return_EUR_based = lag(USD) / USD - 1)

# Plot af monthly returns i procent
ggplot(monthly, aes(x = period, y = return_EUR_based)) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  labs(
    title = "Monthly Returns of Holding USD (EUR-based investor)",
    x = "Date",
    y = "Monthly Return (%)"
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  theme_minimal(base_size = 13)

```

#### Svensson parameters
```{r}
Current_year <- read_csv("~/Documents/Uni/5. År/Asset Allocation (PUK)/Current_year.csv")
Current_year <- Current_year %>%
  select(DATA_TYPE_FM, TIME_PERIOD, OBS_VALUE)

nss_z <- function(beta0, beta1, beta2, beta3 = 0, tau1, tau2 = Inf, TTM) {
  h  <- function(T, tau) ifelse(T == 0, 1, (1 - exp(-T / tau)) / (T / tau))
  t1 <- h(TTM, tau1)
  t2 <- t1 - exp(-TTM / tau1)
  t3 <- ifelse(is.finite(tau2),
               h(TTM, tau2) - exp(-TTM / tau2),
               0)
  beta0 + beta1 * t1 + beta2 * t2 + beta3 * t3
}

TTM_1m <- 1/12  # 1 month in years

# df has columns: TIME_PERIOD, DATA_TYPE_FM, OBS_VALUE (one row per param per day)
daily_z1m <- Current_year %>%
  mutate(
    DATA_TYPE_FM = toupper(str_trim(as.character(DATA_TYPE_FM))),
    TIME_PERIOD  = as.Date(TIME_PERIOD)
  ) %>%
  filter(DATA_TYPE_FM %in% c("BETA0","BETA1","BETA2","BETA3","TAU1","TAU2")) %>%
  distinct(TIME_PERIOD, DATA_TYPE_FM, .keep_all = TRUE) %>%  # de-dup if needed
  pivot_wider(names_from = DATA_TYPE_FM, values_from = OBS_VALUE) %>%
  arrange(TIME_PERIOD) %>%
  mutate(
    BETA0 = BETA0 / 100,
    BETA1 = BETA1 / 100,
    BETA2 = BETA2 / 100,
    BETA3 = BETA3 / 100,
    z_1m  = nss_z(BETA0, BETA1, BETA2, BETA3, TAU1, TAU2, TTM = 1/12))

# (Optional) plot the daily 1-month zero rate
ggplot(daily_z1m, aes(TIME_PERIOD, z_1m)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1)) +
  labs(
    title = "Daily 1-Month Zero-Coupon Rate from NSS Parameters",
    x = "Date", y = "Zero rate (1m, annualized)"
  ) +
  theme_minimal(base_size = 13)

# Compounded (exponential)
daily_z1m <- daily_z1m %>%
  mutate(RF_1m = exp(z_1m * (1/12)) - 1)

# End-of-month RF series, if you prefer monthly observations
RF_eom <- daily_z1m %>%
  group_by(month = floor_date(TIME_PERIOD, "month")) %>%
  slice_tail(n = 1) %>%
  ungroup() %>%
  select(month, z_1m, RF_1m)

# (Optional) plot the compounded 1-month zero rate
ggplot(RF_eom, aes(x = month, y = RF_1m)) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.01)) +
  labs(
    title = "EUR Risk-Free Rate (1-Month Zero-Coupon, Continuously Compounded)",
    subtitle = "Derived from Svensson zero-coupon curve parameters",
    x = "Date",
    y = "Monthly risk-free return"
  ) +
  theme_minimal(base_size = 13)



# (Optional) end-of-month series if you prefer monthly observations
z1m_eom <- daily_z1m %>%
  group_by(month = floor_date(TIME_PERIOD, "month")) %>%
  slice_tail(n = 1) %>%
  ungroup() %>%
  select(month, z_1m)

ggplot(z1m_eom, aes(month, z_1m)) +
  geom_line() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1)) +
  labs(
    title = "1-Month Zero-Coupon Rate from NSS Parameters",
    x = "Date", y = "Zero rate (1m, annualized)"
  ) +
  theme_minimal(base_size = 13)
```
#### Adjusting monthly returns
```{r}
df <- size_mom_6_euro$subsets$data[[1]] %>% filter(date >= 200409)

r <- filter(size_mom_6_euro$subsets$data[[1]], date >= 200409)[,2:ncol(size_mom_6_euro$subsets$data[[1]])]
n <- filter(size_mom_6_euro$subsets$data[[5]], date >= 200409)[,2:ncol(size_mom_6_euro$subsets$data[[5]])]
a <- filter(size_mom_6_euro$subsets$data[[6]], date >= 200409)[,2:ncol(size_mom_6_euro$subsets$data[[6]])]

total_returns_6_euro <- tibble(date = size_mom_6_euro$subsets$data[[1]]$date[size_mom_6_euro$subsets$data[[1]]$date >= 200409], 
                          r*n*a)
total_returns_6_euro %>% 
  mutate(date = ym(date)) %>% 
  pivot_longer(cols = -date,
               names_to = "group",
               values_to = "value") %>% 
  ggplot(aes(date, value, color = group)) +
  geom_line() +
  facet_wrap(~group, scales = "free") +
  theme(legend.position = "bottom")

total_returns_6_euro <- total_returns_6_euro[,-1] * 1/monthly$USD[1:252]

# total returns givet i mio. EUR
colSums(total_returns_6_euro)/10^6

```

### b)
```{r}
USD_RF <- ff_3_factors$subsets$data[[1]][,c("date","RF")] %>%
  filter(date >= 200409)

USD_RF[(200):252,]$RF
RF_eom[1:8,]$RF_1m*100
```

